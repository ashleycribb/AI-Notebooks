{% extends "base.html" %}

{% block title %}AI-Notebooks Dashboard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-tachometer-alt me-2"></i>Dashboard</h1>
            <div>
                <a href="/playground" class="btn btn-primary me-2">
                    <i class="fas fa-play me-1"></i>Model Playground
                </a>
                <button class="btn btn-outline-secondary" onclick="refreshNotebooks()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-book fa-2x text-primary mb-2"></i>
                <h5 class="card-title">{{ notebooks|length }}</h5>
                <p class="card-text text-muted">Notebooks</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-robot fa-2x text-success mb-2"></i>
                <h5 class="card-title" id="modelCount">-</h5>
                <p class="card-text text-muted">AI Models</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-layer-group fa-2x text-warning mb-2"></i>
                <h5 class="card-title" id="categoryCount">-</h5>
                <p class="card-text text-muted">Categories</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-clock fa-2x text-info mb-2"></i>
                <h5 class="card-title">Active</h5>
                <p class="card-text text-muted">Status</p>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="d-grid">
                            <button class="btn btn-outline-primary" onclick="openDemo()">
                                <i class="fas fa-play-circle me-2"></i>
                                Try AI Assistant Demo
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="d-grid">
                            <button class="btn btn-outline-success" onclick="createNewNotebook()">
                                <i class="fas fa-plus-circle me-2"></i>
                                Create New Notebook
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="d-grid">
                            <button class="btn btn-outline-info" onclick="showTutorial()">
                                <i class="fas fa-graduation-cap me-2"></i>
                                View Tutorial
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Notebooks Grid -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-book me-2"></i>Available Notebooks</h5>
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="viewMode" id="gridView" autocomplete="off" checked>
                    <label class="btn btn-outline-secondary btn-sm" for="gridView">
                        <i class="fas fa-th"></i>
                    </label>
                    
                    <input type="radio" class="btn-check" name="viewMode" id="listView" autocomplete="off">
                    <label class="btn btn-outline-secondary btn-sm" for="listView">
                        <i class="fas fa-list"></i>
                    </label>
                </div>
            </div>
            <div class="card-body">
                <!-- Search and Filter -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="searchNotebooks" placeholder="Search notebooks...">
                    </div>
                    <div class="col-md-6">
                        <select class="form-select" id="filterCategory">
                            <option value="">All Categories</option>
                        </select>
                    </div>
                </div>
                
                <!-- Grid View -->
                <div id="notebooksGrid" class="row">
                    {% for notebook in notebooks %}
                    <div class="col-lg-4 col-md-6 mb-4 notebook-item" data-category="{{ notebook.category }}" data-name="{{ notebook.name.lower() }}">
                        <div class="card notebook-card h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title">{{ notebook.name }}</h6>
                                    <span class="badge bg-secondary category-badge">{{ notebook.category }}</span>
                                </div>
                                <p class="card-text text-muted small">
                                    <i class="fas fa-folder me-1"></i>{{ notebook.path }}<br>
                                    <i class="fas fa-clock me-1"></i>{{ notebook.modified[:10] }}<br>
                                    <i class="fas fa-file me-1"></i>{{ "%.1f"|format(notebook.size / 1024) }} KB
                                </p>
                            </div>
                            <div class="card-footer bg-transparent">
                                <div class="btn-group w-100" role="group">
                                    <a href="/notebook/{{ notebook.path }}" class="btn btn-primary btn-sm">
                                        <i class="fas fa-eye me-1"></i>View
                                    </a>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="getNotebookInfo('{{ notebook.path }}')">
                                        <i class="fas fa-info-circle me-1"></i>Info
                                    </button>
                                    <button class="btn btn-outline-success btn-sm" onclick="openInJupyter('{{ notebook.path }}')">
                                        <i class="fas fa-external-link-alt me-1"></i>Jupyter
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- List View (hidden by default) -->
                <div id="notebooksList" class="d-none">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th>Size</th>
                                    <th>Modified</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for notebook in notebooks %}
                                <tr class="notebook-item" data-category="{{ notebook.category }}" data-name="{{ notebook.name.lower() }}">
                                    <td>
                                        <i class="fas fa-book me-2"></i>
                                        <strong>{{ notebook.name }}</strong>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ notebook.category }}</span>
                                    </td>
                                    <td>{{ "%.1f"|format(notebook.size / 1024) }} KB</td>
                                    <td>{{ notebook.modified[:10] }}</td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="/notebook/{{ notebook.path }}" class="btn btn-primary">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <button class="btn btn-outline-secondary" onclick="getNotebookInfo('{{ notebook.path }}')">
                                                <i class="fas fa-info-circle"></i>
                                            </button>
                                            <button class="btn btn-outline-success" onclick="openInJupyter('{{ notebook.path }}')">
                                                <i class="fas fa-external-link-alt"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                {% if not notebooks %}
                <div class="text-center py-5">
                    <i class="fas fa-book fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No notebooks found</h5>
                    <p class="text-muted">Add some notebooks to the notebooks/ directory to get started.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Notebook Info Modal -->
<div class="modal fade" id="notebookInfoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle me-2"></i>Notebook Information
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="notebookInfoContent">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
        loadModelCount();
        setupCategoryFilter();
        setupSearch();
        setupViewToggle();
    });
    
    function loadModelCount() {
        fetch('/api/models')
            .then(response => response.json())
            .then(data => {
                document.getElementById('modelCount').textContent = data.models ? data.models.length : 0;
            })
            .catch(error => {
                document.getElementById('modelCount').textContent = '0';
            });
    }
    
    function setupCategoryFilter() {
        const categories = new Set();
        document.querySelectorAll('.notebook-item').forEach(item => {
            const category = item.dataset.category;
            if (category && category !== 'root') {
                categories.add(category);
            }
        });
        
        const filterSelect = document.getElementById('filterCategory');
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category.charAt(0).toUpperCase() + category.slice(1);
            filterSelect.appendChild(option);
        });
        
        document.getElementById('categoryCount').textContent = categories.size;
        
        filterSelect.addEventListener('change', filterNotebooks);
    }
    
    function setupSearch() {
        document.getElementById('searchNotebooks').addEventListener('input', filterNotebooks);
    }
    
    function setupViewToggle() {
        document.getElementById('gridView').addEventListener('change', function() {
            if (this.checked) {
                document.getElementById('notebooksGrid').classList.remove('d-none');
                document.getElementById('notebooksList').classList.add('d-none');
            }
        });
        
        document.getElementById('listView').addEventListener('change', function() {
            if (this.checked) {
                document.getElementById('notebooksGrid').classList.add('d-none');
                document.getElementById('notebooksList').classList.remove('d-none');
            }
        });
    }
    
    function filterNotebooks() {
        const searchTerm = document.getElementById('searchNotebooks').value.toLowerCase();
        const categoryFilter = document.getElementById('filterCategory').value;
        
        document.querySelectorAll('.notebook-item').forEach(item => {
            const name = item.dataset.name;
            const category = item.dataset.category;
            
            const matchesSearch = !searchTerm || name.includes(searchTerm);
            const matchesCategory = !categoryFilter || category === categoryFilter;
            
            if (matchesSearch && matchesCategory) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    }
    
    function refreshNotebooks() {
        location.reload();
    }
    
    function getNotebookInfo(notebookPath) {
        const modal = new bootstrap.Modal(document.getElementById('notebookInfoModal'));
        modal.show();
        
        fetch(`/api/notebook/${notebookPath}/metadata`)
            .then(response => response.json())
            .then(data => {
                const content = document.getElementById('notebookInfoContent');
                if (data.error) {
                    content.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                } else {
                    content.innerHTML = `
                        <table class="table">
                            <tr><th>Title:</th><td>${data.title}</td></tr>
                            <tr><th>Total Cells:</th><td>${data.cells}</td></tr>
                            <tr><th>Code Cells:</th><td>${data.code_cells}</td></tr>
                            <tr><th>Markdown Cells:</th><td>${data.markdown_cells}</td></tr>
                            <tr><th>Last Modified:</th><td>${formatTimestamp(data.last_modified)}</td></tr>
                        </table>
                    `;
                }
            })
            .catch(error => {
                document.getElementById('notebookInfoContent').innerHTML = 
                    `<div class="alert alert-danger">Error loading notebook info: ${error.message}</div>`;
            });
    }
    
    function openInJupyter(notebookPath) {
        // This would typically open in Jupyter Lab/Notebook
        // For now, we'll show a message
        showToast(`Opening ${notebookPath} in Jupyter...`, 'info');
        // In a real implementation, this might open a new tab with Jupyter
        // window.open(`/jupyter/notebooks/${notebookPath}`, '_blank');
    }
    
    function openDemo() {
        window.open('/notebook/ai_assistant_demo.ipynb', '_blank');
    }
    
    function createNewNotebook() {
        showToast('New notebook creation feature coming soon!', 'info');
    }
    
    function showTutorial() {
        showToast('Tutorial feature coming soon!', 'info');
    }
</script>
{% endblock %}
name: Dependabot Auto-Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  dependabot:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Dependabot metadata
      id: metadata
      uses: dependabot/fetch-metadata@v1
      with:
        github-token: "${{ secrets.GITHUB_TOKEN }}"

    - name: Install and test dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
        # Test core imports to ensure dependencies work
        python -c "
        import sys
        sys.path.insert(0, '.')
        
        # Test core imports
        try:
            import pandas as pd
            import numpy as np
            import matplotlib.pyplot as plt
            import seaborn as sns
            print('âœ… Core data science libraries work')
        except ImportError as e:
            print(f'âŒ Core library import failed: {e}')
            sys.exit(1)
        
        # Test AI Assistant imports (non-critical)
        try:
            from ai_assistant import AIAssistantMagics, ModelPlayground, setup_assistant
            print('âœ… AI Assistant imports successful')
        except ImportError as e:
            print(f'âš ï¸ AI Assistant import warning (non-critical): {e}')
        
        # Test web interface imports (non-critical)
        try:
            import flask
            import flask_socketio
            print('âœ… Web interface dependencies available')
        except ImportError as e:
            print(f'âš ï¸ Web interface import warning (non-critical): {e}')
        
        print('ğŸ‰ Dependency validation completed!')
        "
    
    - name: Wait for other tests to complete
      uses: lewagon/wait-on-check-action@v1.3.1
      with:
        ref: ${{ github.event.pull_request.head.sha }}
        check-name: 'test'
        repo-token: ${{ secrets.GITHUB_TOKEN }}
        wait-interval: 10
        allowed-conclusions: success
      continue-on-error: true
    
    - name: Auto-approve and enable auto-merge for safe updates
      if: steps.metadata.outputs.update-type == 'version-update:semver-patch' || steps.metadata.outputs.update-type == 'version-update:semver-minor'
      run: |
        # Approve the PR
        gh pr review "$PR_URL" --approve --body "âœ… Automated approval: Safe dependency update (patch/minor) with passing tests."
        
        # Enable auto-merge with squash
        gh pr merge --auto --squash --delete-branch "$PR_URL"
        
        # Add success comment
        gh pr comment "$PR_URL" --body "ğŸš€ **Dependabot Auto-Merge Enabled**
        
        This dependency update has been automatically approved because:
        - âœ… It's a safe update (patch or minor version)
        - âœ… All dependency tests passed
        - âœ… Core functionality verified
        
        The PR will be automatically merged once all status checks pass."
      env:
        PR_URL: ${{github.event.pull_request.html_url}}
        GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
    
    - name: Comment on major version updates
      if: steps.metadata.outputs.update-type == 'version-update:semver-major'
      run: |
        gh pr comment "$PR_URL" --body "âš ï¸ **Major Version Update - Manual Review Required**
        
        This is a major version update that may contain breaking changes.
        
        **Before merging, please:**
        - ğŸ“– Review the changelog for breaking changes
        - ğŸ§ª Test the updated dependencies thoroughly  
        - ğŸ”§ Update any affected code if necessary
        - ğŸ¯ Verify all AI Assistant and web interface features still work
        
        **Academic Research Features to Test:**
        - Magic commands (%ai_chat, %research_load, etc.)
        - Model playground functionality
        - Web interface and Socket.IO features
        - Academic database integrations
        
        If you're confident this update is safe, manually approve and merge this PR."
      env:
        PR_URL: ${{github.event.pull_request.html_url}}
        GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}

    - name: Handle test failures
      if: failure()
      run: |
        gh pr comment "$PR_URL" --body "âŒ **Dependency Update Failed Tests**
        
        The dependency update caused test failures. Please investigate:
        
        1. ğŸ” Check the test output above for specific errors
        2. ğŸ”§ Verify dependency compatibility with our codebase
        3. ğŸ“ Update any code affected by dependency changes
        4. ğŸ§ª Test locally before merging
        
        **Common Issues:**
        - Breaking API changes in updated libraries
        - New dependency conflicts
        - Changed import paths or function signatures
        
        This PR will **not** be automatically merged due to test failures."
      env:
        PR_URL: ${{github.event.pull_request.html_url}}
        GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}